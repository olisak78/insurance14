apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "developer-portal-backend.fullname" . }}-init-data
  labels:
    {{- include "developer-portal-backend.labels" . | nindent 4 }}
    app.kubernetes.io/component: init-data
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "developer-portal-backend.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: init-data
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-db
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          echo "Waiting for PostgreSQL to be ready..."
          until nc -z {{ include "developer-portal-backend.databaseHost" . }} {{ include "developer-portal-backend.databasePort" . }}; do
            echo "PostgreSQL is unavailable - sleeping"
            sleep 2
          done
          echo "PostgreSQL is up - waiting 10 more seconds for full readiness"
          sleep 10
      containers:
      - name: init-data
        # Use specialized init-data image with Go runtime
        image: "{{ .Values.initData.image.repository }}:{{ .Values.initData.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        command:
        - /bin/sh
        - -c
        - |
          echo "Loading initial data into database..."
          cd /app
          go run scripts/load_initial_data.go
          echo "Initial data loaded successfully!"
        envFrom:
        - configMapRef:
            name: {{ include "developer-portal-backend.fullname" . }}
        - secretRef:
            name: {{ include "developer-portal-backend.fullname" . }}
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 128Mi

